'use client';

import { useState } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt } from 'wagmi';
import { parseEther } from 'viem';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  Loader2, 
  Sparkles, 
  Image as ImageIcon, 
  Upload, 
  Wand2, 
  Brain,
  CheckCircle,
  AlertCircle,
  Eye,
  Copy,
  RefreshCw,
  Download,
  Share2
} from 'lucide-react';
import { CONTRACTS, PROMPT_NFT_ABI, getStyleInfo } from '@/config/web3';
import { AIWorkflowState, ArtStyle } from '@/types/api';
import { PromptInput } from './PromptInput';
import { StyleSelector } from './StyleSelector';
import { AIPreview } from './AIPreview';
import { MintButton } from './MintButton';
import { cn, copyToClipboard } from '@/lib/utils';

export function MintNFT() {
  const { address, isConnected } = useAccount();
  const [userInput, setUserInput] = useState('');
  const [style, setStyle] = useState<ArtStyle>('classic');
  const [workflow, setWorkflow] = useState<AIWorkflowState>({
    step: 'idle',
    progress: 0,
    message: 'å‡†å¤‡å¼€å§‹AIåˆ›ä½œ...'
  });
  const [showOptimizedPrompt, setShowOptimizedPrompt] = useState(false);

  const { writeContract, data: hash, error: contractError, isPending } = useWriteContract();
  
  const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({
    hash,
  });

  // å¼€å§‹AIå·¥ä½œæµç¨‹
  const startAIWorkflow = async () => {
    if (!userInput.trim()) {
      setWorkflow(prev => ({ ...prev, error: 'è¯·è¾“å…¥ç¥å…½æè¿°' }));
      return;
    }

    try {
      // é‡ç½®çŠ¶æ€
      setWorkflow({
        step: 'optimizing',
        progress: 10,
        message: 'ğŸ§  DeepSeekæ­£åœ¨ä¼˜åŒ–ä½ çš„åˆ›æ„...',
        userInput,
        startTime: Date.now()
      });

      // è°ƒç”¨ç”ŸæˆAPI
      const response = await fetch('/api/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userInput,
          style,
          rarity: 'random'
        }),
      });

      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
      }

      // æ›´æ–°ä¸ºç”Ÿæˆå®ŒæˆçŠ¶æ€
      setWorkflow({
        step: 'complete',
        progress: 100,
        message: 'âœ¨ AIåˆ›ä½œå®Œæˆï¼Œå‡†å¤‡é“¸é€ ç¥å…½NFTï¼',
        userInput,
        optimizedPrompt: data.optimizedPrompt,
        imageUrl: data.imageUrl,
        endTime: Date.now()
      });

    } catch (error) {
      console.error('AIå·¥ä½œæµé”™è¯¯:', error);
      setWorkflow(prev => ({
        ...prev,
        step: 'idle',
        progress: 0,
        message: 'å‡†å¤‡å¼€å§‹AIåˆ›ä½œ...',
        error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      }));
    }
  };

  // é“¸é€ NFT
  const mintNFT = async () => {
    if (!address || !workflow.imageUrl || !workflow.optimizedPrompt) {
      setWorkflow(prev => ({ ...prev, error: 'è¯·å…ˆå®ŒæˆAIåˆ›ä½œæˆ–è¿æ¥é’±åŒ…' }));
      return;
    }

    try {
      setWorkflow(prev => ({
        ...prev,
        step: 'uploading',
        progress: 85,
        message: 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ åˆ°IPFS...'
      }));

      // ä¸Šä¼ åˆ°IPFS
      const uploadResponse = await fetch('/api/upload-ipfs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          imageUrl: workflow.imageUrl,
          originalInput: workflow.userInput,
          optimizedPrompt: workflow.optimizedPrompt,
          style,
          creator: address,
        }),
      });

      const uploadData = await uploadResponse.json();
      
      if (!uploadResponse.ok) {
        throw new Error(uploadData.error || 'IPFSä¸Šä¼ å¤±è´¥');
      }

      setWorkflow(prev => ({
        ...prev,
        step: 'minting',
        progress: 90,
        message: 'â›ï¸ æ­£åœ¨é“¸é€ NFT...',
        ipfsData: uploadData.ipfs,
        metadata: uploadData.metadata
      }));

      // é“¸é€ NFT
      const tokenURI = uploadData.mintInfo?.tokenURI || workflow.optimizedPrompt;
      
      writeContract({
        address: CONTRACTS.PROMPT_NFT,
        abi: PROMPT_NFT_ABI,
        functionName: 'mint',
        args: [address, tokenURI],
        value: parseEther('0'),
      });

    } catch (error) {
      console.error('é“¸é€ é”™è¯¯:', error);
      setWorkflow(prev => ({
        ...prev,
        error: error instanceof Error ? error.message : 'é“¸é€ å¤±è´¥'
      }));
    }
  };

  // é‡ç½®å·¥ä½œæµ
  const resetWorkflow = () => {
    setUserInput('');
    setWorkflow({
      step: 'idle',
      progress: 0,
      message: 'å‡†å¤‡å¼€å§‹AIåˆ›ä½œ...'
    });
    setShowOptimizedPrompt(false);
  };

  // é‡æ–°ç”Ÿæˆ
  const regenerateImage = () => {
    setWorkflow(prev => ({
      step: 'idle',
      progress: 0,
      message: 'å‡†å¤‡é‡æ–°ç”Ÿæˆ...',
      userInput: prev.userInput
    }));
  };

  // æˆåŠŸé¡µé¢
  if (isConfirmed) {
    return (
      <div className="w-full max-w-2xl mx-auto">
        <Card className="bg-gradient-to-br from-green-500/10 to-emerald-500/10 border-green-500/20">
          <CardHeader className="text-center">
            <div className="flex justify-center mb-4">
              <div className="relative">
                <CheckCircle className="h-16 w-16 text-green-500" />
                <div className="absolute -inset-2 rounded-full bg-green-500/20 animate-ping" />
              </div>
            </div>
            <CardTitle className="text-2xl font-bold text-green-400">
              ğŸ‰ ç¥å…½è¯ç”ŸæˆåŠŸï¼
            </CardTitle>
            <CardDescription className="text-green-300">
              ä½ çš„å±±æµ·ç¥å…½å·²ç»åœ¨åŒºå—é“¾ä¸Šæ°¸ç”Ÿï¼Œå¿«å»å›¾é‰´æ¬£èµå§ï¼
            </CardDescription>
          </CardHeader>
          <CardContent className="text-center space-y-4">
            {workflow.imageUrl && (
              <div className="relative max-w-sm mx-auto">
                <img
                  src={workflow.imageUrl}
                  alt="Your Beast"
                  className="w-full rounded-lg shadow-lg"
                />
                <Badge className="absolute top-2 right-2 bg-green-500">
                  âœ¨ ä½ çš„ç¥å…½
                </Badge>
              </div>
            )}
            
            <div className="flex flex-wrap gap-2 justify-center">
              <Button onClick={resetWorkflow} variant="outline">
                <Sparkles className="mr-2 h-4 w-4" />
                åˆ›é€ ä¸‹ä¸€åªç¥å…½
              </Button>
              <Button asChild variant="secondary">
                <a href="/gallery">
                  <Eye className="mr-2 h-4 w-4" />
                  æŸ¥çœ‹å›¾é‰´
                </a>
              </Button>
              <Button asChild variant="secondary">
                <a href="/marketplace">
                  <Share2 className="mr-2 h-4 w-4" />
                  å»å¸‚åœºçœ‹çœ‹
                </a>
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="w-full max-w-6xl mx-auto space-y-8">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="text-center space-y-4">
        <div className="flex items-center justify-center space-x-2">
          <div className="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500">
            <Sparkles className="h-6 w-6 text-white" />
          </div>
          <h1 className="text-3xl font-bold text-white">AIç¥å…½åˆ›é€ å·¥åŠ</h1>
        </div>
        <p className="text-lg text-white/70 max-w-2xl mx-auto">
          DeepSeek + æ™ºè°±AI åŒé‡æŠ€æœ¯åŠ æŒï¼Œè®©ä½ çš„åˆ›æ„å˜æˆç‹¬ç‰¹çš„å±±æµ·ç¥å…½NFT
        </p>
      </div>

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="grid lg:grid-cols-2 gap-8">
        {/* å·¦ä¾§ï¼šè¾“å…¥å’Œæ§åˆ¶åŒº */}
        <div className="space-y-6">
          <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-white">
                <Brain className="h-5 w-5" />
                åˆ›æ„è¾“å…¥
              </CardTitle>
              <CardDescription className="text-white/70">
                æè¿°ä½ å¿ƒä¸­çš„ç¥å…½ï¼ŒAIå°†ä¸ºä½ å¸¦æ¥æƒŠå–œ
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <PromptInput
                value={userInput}
                onChange={setUserInput}
                placeholder="æè¿°ä½ å¿ƒä¸­çš„ç¥å…½ï¼Œæ¯”å¦‚ï¼šå¨æ­¦çš„ç«ç„°ç¥é¾™ï¼Œæˆ–è€…ç¥ç§˜çš„æ°´æ™¶å‡¤å‡°..."
                disabled={workflow.step !== 'idle'}
              />
              
              <StyleSelector
                selected={style}
                onSelect={setStyle}
                disabled={workflow.step !== 'idle'}
              />
            </CardContent>
          </Card>

          {/* AIå·¥ä½œæµç¨‹çŠ¶æ€ */}
          {workflow.step !== 'idle' && (
            <Card className="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border-purple-500/20">
              <CardContent className="p-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm font-medium text-white">AIåˆ›ä½œè¿›åº¦</span>
                    <span className="text-sm text-white/60">{workflow.progress}%</span>
                  </div>
                  
                  <Progress 
                    value={workflow.progress} 
                    variant="gradient"
                    className="h-2" 
                  />
                  
                  <div className="flex items-center gap-2">
                    {workflow.step === 'optimizing' && <Brain className="h-4 w-4 animate-pulse text-purple-400" />}
                    {workflow.step === 'generating' && <Wand2 className="h-4 w-4 animate-pulse text-pink-400" />}
                    {workflow.step === 'uploading' && <Upload className="h-4 w-4 animate-pulse text-blue-400" />}
                    {workflow.step === 'minting' && <Loader2 className="h-4 w-4 animate-spin text-green-400" />}
                    {workflow.step === 'complete' && <CheckCircle className="h-4 w-4 text-green-400" />}
                    <span className="text-sm text-white">{workflow.message}</span>
                  </div>
                  
                  {workflow.error && (
                    <div className="flex items-center gap-2 text-red-400 bg-red-500/10 p-3 rounded-lg">
                      <AlertCircle className="h-4 w-4" />
                      <span className="text-sm">{workflow.error}</span>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          )}

          {/* ä¼˜åŒ–åçš„promptå±•ç¤º */}
          {workflow.optimizedPrompt && (
            <Card className="bg-white/5 border-white/10">
              <CardContent className="p-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-sm font-medium text-white flex items-center gap-2">
                    <Brain className="h-4 w-4 text-purple-400" />
                    DeepSeekä¼˜åŒ–åçš„æè¿°
                  </h4>
                  <div className="flex gap-2">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => setShowOptimizedPrompt(!showOptimizedPrompt)}
                    >
                      <Eye className="h-4 w-4" />
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => copyToClipboard(workflow.optimizedPrompt!)}
                    >
                      <Copy className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
                {showOptimizedPrompt && (
                  <p className="text-sm text-white/80 leading-relaxed">
                    {workflow.optimizedPrompt}
                  </p>
                )}
              </CardContent>
            </Card>
          )}

          {/* æ§åˆ¶æŒ‰é’® */}
          <div className="space-y-3">
            {workflow.step === 'idle' && (
              <Button
                onClick={startAIWorkflow}
                disabled={!userInput.trim()}
                className="w-full"
                size="lg"
                variant="gradient"
              >
                <Brain className="mr-2 h-5 w-5" />
                å¼€å§‹AIåˆ›ä½œ
              </Button>
            )}

            {workflow.step === 'complete' && (
              <div className="space-y-2">
                {!isConnected ? (
                  <div className="text-center text-white/60 py-4">
                    è¯·å…ˆè¿æ¥é’±åŒ…ç»§ç»­é“¸é€ 
                  </div>
                ) : (
                  <MintButton
                    onClick={mintNFT}
                    disabled={isPending || isConfirming}
                    loading={isPending || isConfirming}
                    loadingText={isPending ? 'å‡†å¤‡é“¸é€ ...' : 'é“¸é€ ä¸­...'}
                  />
                )}
                
                <Button
                  onClick={regenerateImage}
                  variant="outline"
                  className="w-full"
                >
                  <RefreshCw className="mr-2 h-4 w-4" />
                  é‡æ–°ç”Ÿæˆå›¾ç‰‡
                </Button>
              </div>
            )}
          </div>
        </div>

        {/* å³ä¾§ï¼šé¢„è§ˆåŒºåŸŸ */}
        <div className="space-y-6">
          <AIPreview
            imageUrl={workflow.imageUrl}
            isLoading={workflow.step === 'optimizing' || workflow.step === 'generating'}
            style={style}
            onDownload={workflow.imageUrl ? () => {
              const link = document.createElement('a');
              link.href = workflow.imageUrl!;
              link.download = 'shanhai-beast.png';
              link.click();
            } : undefined}
          />

          {/* åŠŸèƒ½è¯´æ˜ */}
          <Card className="bg-white/5 border-white/10">
            <CardContent className="p-6">
              <h3 className="text-lg font-semibold text-white mb-4">âœ¨ åˆ›ä½œç‰¹è‰²</h3>
              <div className="space-y-3 text-sm text-white/70">
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <Brain className="h-3 w-3 text-purple-400" />
                  </div>
                  <div>
                    <div className="font-medium text-white">åŒAIåä½œ</div>
                    <div>DeepSeekä¼˜åŒ–åˆ›æ„ + æ™ºè°±AIç”Ÿæˆå›¾åƒ</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-pink-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <Sparkles className="h-3 w-3 text-pink-400" />
                  </div>
                  <div>
                    <div className="font-medium text-white">å…¬å¹³ç¨€æœ‰åº¦</div>
                    <div>æ™ºèƒ½åˆçº¦éšæœºåˆ†é…ï¼ŒVRFç¡®ä¿å…¬å¹³æ€§</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <Upload className="h-3 w-3 text-green-400" />
                  </div>
                  <div>
                    <div className="font-medium text-white">æ°¸ä¹…å­˜å‚¨</div>
                    <div>å›¾ç‰‡å’Œå…ƒæ•°æ®å­˜å‚¨åœ¨IPFSä¸Šï¼Œæ°¸ä¸ä¸¢å¤±</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <Coins className="h-3 w-3 text-yellow-400" />
                  </div>
                  <div>
                    <div className="font-medium text-white">ä»£å¸å¥–åŠ±</div>
                    <div>æ¯æ¬¡é“¸é€ è·å¾—50 SHTä»£å¸å¥–åŠ±</div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* é”™è¯¯ä¿¡æ¯æ˜¾ç¤º */}
      {contractError && (
        <Card className="bg-red-500/10 border-red-500/20">
          <CardContent className="p-4">
            <div className="flex items-center gap-2 text-red-400">
              <AlertCircle className="h-5 w-5" />
              <div>
                <div className="font-medium">é“¸é€ å¤±è´¥</div>
                <div className="text-sm opacity-80">{contractError.message}</div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}