'use client';

import { useState, useEffect } from 'react';
import { useAccount, useReadContract, useWriteContract, useWaitForTransactionReceipt } from 'wagmi';
import { parseEther, formatEther } from 'viem';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Coins, Gift, Loader2, RefreshCw, TrendingUp, Zap, CheckCircle, AlertCircle } from 'lucide-react';

// å¢å¼ºç‰ˆåˆçº¦åœ°å€
const SHT_TOKEN_ADDRESS = '0xe2241E16949d01356bA43D9401D3775E29Ea9F4c' as const;

// å®Œæ•´çš„SHT Token ABI
const SHT_TOKEN_ABI = [
  {
    "inputs": [{"internalType": "address","name": "account","type": "address"}],
    "name": "balanceOf",
    "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {"internalType": "address[]","name": "recipients","type": "address[]"},
      {"internalType": "uint256[]","name": "amounts","type": "uint256[]"}
    ],
    "name": "airdrop",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalSupply",
    "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address","name": "user","type": "address"}],
    "name": "getUserStats",
    "outputs": [
      {
        "components": [
          {"internalType": "uint256","name": "lastClaimTime","type": "uint256"},
          {"internalType": "uint256","name": "lastNFTClaimTime","type": "uint256"},
          {"internalType": "uint256","name": "consecutiveDays","type": "uint256"},
          {"internalType": "uint256","name": "totalClaimed","type": "uint256"},
          {"internalType": "uint256","name": "totalNFTRewards","type": "uint256"},
          {"internalType": "uint256","name": "mintCount","type": "uint256"}
        ],
        "internalType": "struct ShanHaiToken.UserStats",
        "name": "",
        "type": "tuple"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "claimDailyReward",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "address","name": "user","type": "address"}],
    "name": "canClaimToday",
    "outputs": [{"internalType": "bool","name": "","type": "bool"}],
    "stateMutability": "view",
    "type": "function"
  }
] as const;

export default function CompleteSHTRewardsPage() {
  const { address, isConnected } = useAccount();
  const [mounted, setMounted] = useState(false);
  const [lastRefresh, setLastRefresh] = useState<Date | null>(null);

  useEffect(() => {
    setMounted(true);
  }, []);

  // è¯»å–SHTä½™é¢
  const { data: balance, refetch: refetchBalance, isLoading: balanceLoading, error: balanceError } = useReadContract({
    address: SHT_TOKEN_ADDRESS,
    abi: SHT_TOKEN_ABI,
    functionName: 'balanceOf',
    args: address ? [address] : undefined,
    query: { 
      enabled: !!address && mounted,
      refetchInterval: 5000, // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
    },
  });

  // è¯»å–æ€»ä¾›åº”é‡
  const { data: totalSupply, isLoading: totalSupplyLoading } = useReadContract({
    address: SHT_TOKEN_ADDRESS,
    abi: SHT_TOKEN_ABI,
    functionName: 'totalSupply',
    query: { 
      enabled: mounted,
      refetchInterval: 10000, // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
    },
  });

  // è¯»å–ç”¨æˆ·ç»Ÿè®¡
  const { data: userStats, refetch: refetchUserStats } = useReadContract({
    address: SHT_TOKEN_ADDRESS,
    abi: SHT_TOKEN_ABI,
    functionName: 'getUserStats',
    args: address ? [address] : undefined,
    query: { 
      enabled: !!address && mounted,
      refetchInterval: 10000,
    },
  });

  // è¯»å–æ˜¯å¦å¯ä»¥ç­¾åˆ°
  const { data: canClaim, refetch: refetchCanClaim } = useReadContract({
    address: SHT_TOKEN_ADDRESS,
    abi: SHT_TOKEN_ABI,
    functionName: 'canClaimToday',
    args: address ? [address] : undefined,
    query: { 
      enabled: !!address && mounted,
      refetchInterval: 5000,
    },
  });

  // ç©ºæŠ•åˆçº¦è°ƒç”¨
  const { writeContract, data: hash, error, isPending } = useWriteContract();

  // ç­‰å¾…äº¤æ˜“ç¡®è®¤
  const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({
    hash,
  });

  // ç©ºæŠ•50 SHTåŠŸèƒ½
  const handleAirdrop = async () => {
    if (!address || !isConnected) {
      alert('è¯·å…ˆè¿æ¥é’±åŒ…');
      return;
    }

    try {
      const airdropAmount = parseEther('50'); // 50 SHT
      
      writeContract({
        address: SHT_TOKEN_ADDRESS,
        abi: SHT_TOKEN_ABI,
        functionName: 'airdrop',
        args: [[address], [airdropAmount]],
      });
    } catch (error) {
      console.error('ç©ºæŠ•å¤±è´¥:', error);
    }
  };

  // æ¯æ—¥ç­¾åˆ°åŠŸèƒ½
  const handleDailyClaim = async () => {
    if (!address || !isConnected) {
      alert('è¯·å…ˆè¿æ¥é’±åŒ…');
      return;
    }

    try {
      writeContract({
        address: SHT_TOKEN_ADDRESS,
        abi: SHT_TOKEN_ABI,
        functionName: 'claimDailyReward',
      });
    } catch (error) {
      console.error('æ¯æ—¥ç­¾åˆ°å¤±è´¥:', error);
    }
  };

  // æ‰‹åŠ¨åˆ·æ–°æ‰€æœ‰æ•°æ®
  const refreshAllData = async () => {
    setLastRefresh(new Date());
    await Promise.all([
      refetchBalance(),
      refetchUserStats(), 
      refetchCanClaim()
    ]);
  };

  // ç›‘å¬äº¤æ˜“å®Œæˆï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®
  useEffect(() => {
    if (isConfirmed) {
      setTimeout(() => {
        refreshAllData();
      }, 2000); // 2ç§’ååˆ·æ–°æ‰€æœ‰æ•°æ®
    }
  }, [isConfirmed]);

  if (!mounted) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="flex items-center space-x-2">
          <Loader2 className="h-8 w-8 animate-spin text-primary" />
          <span>æ­£åœ¨åŠ è½½SHTå¥–åŠ±ä¸­å¿ƒ...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6 space-y-6 max-w-4xl">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="text-center space-y-4">
        <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
          ğŸ SHT å¥–åŠ±ä¸­å¿ƒ
        </h1>
        <p className="text-muted-foreground text-lg">
          æŸ¥çœ‹ä½™é¢ â€¢ è·å¾—å¥–åŠ± â€¢ æ¯æ—¥ç­¾åˆ° â€¢ æµ‹è¯•åŠŸèƒ½
        </p>
        <div className="flex justify-center gap-2">
          <Badge variant="secondary">å¢å¼ºç‰ˆ v2.0</Badge>
          <Badge variant="outline">Sepolia æµ‹è¯•ç½‘</Badge>
        </div>
      </div>

      {/* é’±åŒ…è¿æ¥çŠ¶æ€ */}
      <Card className="border-2 border-primary/20">
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Coins className="h-5 w-5" />
            é’±åŒ…è¿æ¥çŠ¶æ€
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex justify-center">
            <ConnectButton />
          </div>
          
          {isConnected && address && (
            <div className="text-center space-y-2 p-4 bg-green-50 rounded-lg border border-green-200">
              <div className="text-sm text-green-600">âœ… é’±åŒ…å·²è¿æ¥</div>
              <div className="font-mono text-xs bg-white p-2 rounded border">
                {address}
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* SHTä½™é¢å’Œç»Ÿè®¡ */}
      {isConnected && (
        <div className="grid md:grid-cols-2 gap-6">
          {/* ä½™é¢æ˜¾ç¤º */}
          <Card className="border-2 border-green-200 bg-gradient-to-br from-green-50 to-emerald-50">
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <div className="flex items-center gap-2 text-green-700">
                  <TrendingUp className="h-6 w-6" />
                  SHT ä»£å¸ä½™é¢
                </div>
                <Button 
                  onClick={refreshAllData}
                  variant="outline" 
                  size="sm"
                  disabled={balanceLoading}
                >
                  {balanceLoading ? (
                    <Loader2 className="h-4 w-4 animate-spin" />
                  ) : (
                    <RefreshCw className="h-4 w-4" />
                  )}
                </Button>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-center space-y-3">
                <div className="text-4xl font-bold text-green-700">
                  {balanceLoading ? (
                    <Loader2 className="h-8 w-8 animate-spin mx-auto" />
                  ) : balanceError ? (
                    <div className="text-red-500 text-base">è¯»å–å¤±è´¥</div>
                  ) : (
                    `${balance ? Number(formatEther(balance)).toLocaleString() : '0'}`
                  )}
                </div>
                <div className="text-lg font-medium text-green-600">SHT</div>
                <div className="text-sm text-green-600">
                  å½“å‰é’±åŒ…ä»£å¸ä½™é¢
                </div>
                {totalSupply && (
                  <div className="text-xs text-muted-foreground pt-2 border-t">
                    æ€»ä¾›åº”é‡: {Number(formatEther(totalSupply)).toLocaleString()} SHT
                  </div>
                )}
                {lastRefresh && (
                  <div className="text-xs text-muted-foreground">
                    æœ€åæ›´æ–°: {lastRefresh.toLocaleTimeString()}
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* ç”¨æˆ·ç»Ÿè®¡ */}
          <Card className="border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-cyan-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-blue-700">
                <Zap className="h-6 w-6" />
                ç”¨æˆ·ç»Ÿè®¡
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-700">
                      {userStats ? userStats[2].toString() : '0'}
                    </div>
                    <div className="text-blue-600">è¿ç»­ç­¾åˆ°</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-700">
                      {userStats ? userStats[5].toString() : '0'}
                    </div>
                    <div className="text-blue-600">é“¸é€ æ¬¡æ•°</div>
                  </div>
                </div>
                <div className="text-center pt-2 border-t">
                  <div className="text-lg font-bold text-blue-700">
                    {userStats ? Number(formatEther(userStats[3])).toLocaleString() : '0'}
                  </div>
                  <div className="text-sm text-blue-600">ç´¯è®¡è·å¾— SHT</div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* å¥–åŠ±åŠŸèƒ½åŒº */}
      {isConnected ? (
        <div className="grid md:grid-cols-2 gap-6">
          {/* 50 SHTç©ºæŠ• */}
          <Card className="border-2 border-red-200 bg-gradient-to-br from-red-50 to-pink-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-red-700">
                <Gift className="h-6 w-6" />
                ğŸ¯ è·å¾— 50 SHT
              </CardTitle>
              <CardDescription className="text-red-600">
                æµ‹è¯•åŠŸèƒ½ - ç«‹å³è·å¾—50ä¸ªSHTä»£å¸
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <Button 
                onClick={handleAirdrop}
                disabled={isPending || isConfirming}
                size="lg"
                className="w-full text-lg py-6"
                variant="destructive"
              >
                {isPending || isConfirming ? (
                  <>
                    <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                    {isPending ? 'å‘é€ä¸­...' : 'ç¡®è®¤ä¸­...'}
                  </>
                ) : (
                  <>
                    <Gift className="mr-2 h-5 w-5" />
                    ğŸ ç«‹å³è·å¾— 50 SHT
                  </>
                )}
              </Button>
            </CardContent>
          </Card>

          {/* æ¯æ—¥ç­¾åˆ° */}
          <Card className="border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-violet-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-purple-700">
                <CheckCircle className="h-6 w-6" />
                æ¯æ—¥ç­¾åˆ°
              </CardTitle>
              <CardDescription className="text-purple-600">
                {canClaim ? 'å¯ä»¥ç­¾åˆ°è·å¾—100 SHT + è¿ç»­å¥–åŠ±' : 'ä»Šæ—¥å·²ç­¾åˆ°'}
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <Button 
                onClick={handleDailyClaim}
                disabled={isPending || isConfirming || !canClaim}
                size="lg"
                className="w-full"
                variant={canClaim ? "default" : "secondary"}
              >
                {isPending || isConfirming ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    å¤„ç†ä¸­...
                  </>
                ) : canClaim ? (
                  <>
                    <CheckCircle className="mr-2 h-4 w-4" />
                    ç«‹å³ç­¾åˆ°
                  </>
                ) : (
                  <>
                    <AlertCircle className="mr-2 h-4 w-4" />
                    ä»Šæ—¥å·²ç­¾åˆ°
                  </>
                )}
              </Button>
            </CardContent>
          </Card>
        </div>
      ) : (
        <Card className="border-2 border-gray-200">
          <CardContent className="pt-6">
            <div className="text-center text-gray-600 py-8">
              <Gift className="h-16 w-16 mx-auto mb-4 opacity-50" />
              <div className="font-medium text-lg mb-2">è¯·å…ˆè¿æ¥é’±åŒ…</div>
              <div className="text-sm">è¿æ¥é’±åŒ…åå³å¯æŸ¥çœ‹ä½™é¢å’Œè·å¾—SHTä»£å¸</div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* äº¤æ˜“çŠ¶æ€æ˜¾ç¤º */}
      {(isPending || isConfirming || isConfirmed || error) && (
        <Card className={`border-2 ${
          error ? 'border-red-200 bg-red-50' : 
          isConfirmed ? 'border-green-200 bg-green-50' : 
          'border-yellow-200 bg-yellow-50'
        }`}>
          <CardContent className="pt-6">
            <div className="text-center space-y-2">
              {isPending && (
                <div className="text-yellow-700">
                  <Loader2 className="h-6 w-6 animate-spin mx-auto mb-2" />
                  <div className="font-medium">ğŸ“¤ äº¤æ˜“å‘é€ä¸­</div>
                  <div className="text-sm">è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...</div>
                </div>
              )}

              {isConfirming && (
                <div className="text-blue-700">
                  <Loader2 className="h-6 w-6 animate-spin mx-auto mb-2" />
                  <div className="font-medium">â³ ç­‰å¾…åŒºå—ç¡®è®¤</div>
                  <div className="text-sm">äº¤æ˜“æ­£åœ¨å¤„ç†ä¸­...</div>
                </div>
              )}

              {isConfirmed && (
                <div className="text-green-700">
                  <CheckCircle className="h-6 w-6 mx-auto mb-2" />
                  <div className="font-medium">ğŸ‰ äº¤æ˜“æˆåŠŸï¼</div>
                  <div className="text-sm">ä»£å¸å·²å‘é€åˆ°ä½ çš„é’±åŒ…</div>
                  {hash && (
                    <div className="text-xs mt-2 font-mono bg-white p-2 rounded border">
                      {hash.slice(0, 10)}...{hash.slice(-8)}
                    </div>
                  )}
                </div>
              )}

              {error && (
                <div className="text-red-700">
                  <AlertCircle className="h-6 w-6 mx-auto mb-2" />
                  <div className="font-medium">âŒ äº¤æ˜“å¤±è´¥</div>
                  <div className="text-sm">
                    {error.message.includes('User rejected') 
                      ? 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“' 
                      : error.message.length > 100 
                        ? error.message.slice(0, 100) + '...' 
                        : error.message}
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {/* ç³»ç»ŸçŠ¶æ€ */}
      <Card>
        <CardHeader>
          <CardTitle>ç³»ç»ŸçŠ¶æ€</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div className="text-center">
              <Badge className="mb-1" variant={mounted ? "default" : "secondary"}>
                {mounted ? 'âœ… å·²åŠ è½½' : 'â³ åŠ è½½ä¸­'}
              </Badge>
              <div className="text-muted-foreground">é¡µé¢çŠ¶æ€</div>
            </div>
            <div className="text-center">
              <Badge className="mb-1" variant={isConnected ? "default" : "secondary"}>
                {isConnected ? 'âœ… å·²è¿æ¥' : 'âŒ æœªè¿æ¥'}
              </Badge>
              <div className="text-muted-foreground">é’±åŒ…çŠ¶æ€</div>
            </div>
            <div className="text-center">
              <Badge className="mb-1" variant={balanceLoading ? "secondary" : "default"}>
                {balanceLoading ? 'â³ åŠ è½½ä¸­' : 'âœ… å·²åŠ è½½'}
              </Badge>
              <div className="text-muted-foreground">ä½™é¢çŠ¶æ€</div>
            </div>
            <div className="text-center">
              <Badge className="mb-1" variant={isPending || isConfirming ? "secondary" : "default"}>
                {isPending || isConfirming ? 'â³ å¤„ç†ä¸­' : 'âœ… å°±ç»ª'}
              </Badge>
              <div className="text-muted-foreground">äº¤æ˜“çŠ¶æ€</div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* åˆçº¦ä¿¡æ¯ */}
      <Card className="bg-muted/30">
        <CardHeader>
          <CardTitle className="text-sm">åˆçº¦ä¿¡æ¯</CardTitle>
        </CardHeader>
        <CardContent className="text-xs space-y-2">
          <div className="grid md:grid-cols-2 gap-2">
            <div>
              <span className="font-medium">SHT Token:</span>
              <div className="font-mono text-muted-foreground break-all">
                {SHT_TOKEN_ADDRESS}
              </div>
            </div>
            <div>
              <span className="font-medium">ç½‘ç»œ:</span> Sepolia æµ‹è¯•ç½‘
            </div>
            <div>
              <span className="font-medium">åŠŸèƒ½:</span> ä½™é¢æŸ¥è¯¢ + ç©ºæŠ• + ç­¾åˆ°
            </div>
            <div>
              <span className="font-medium">åˆ·æ–°:</span> æ¯5ç§’è‡ªåŠ¨æ›´æ–°
            </div>
          </div>
        </CardContent>
      </Card>

      {/* ä½¿ç”¨è¯´æ˜ */}
      <Card className="border-blue-200 bg-blue-50/50">
        <CardContent className="pt-6">
          <div className="text-blue-800">
            <div className="font-medium text-lg mb-3">ğŸ“‹ ä½¿ç”¨è¯´æ˜</div>
            <div className="text-sm space-y-2">
              <div className="flex items-start gap-2">
                <span className="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mt-0.5">1</span>
                <span>è¿æ¥ä½ çš„é’±åŒ… (ç¡®ä¿åˆ‡æ¢åˆ°Sepoliaæµ‹è¯•ç½‘)</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mt-0.5">2</span>
                <span>æŸ¥çœ‹å½“å‰SHTä»£å¸ä½™é¢å’Œç”¨æˆ·ç»Ÿè®¡</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mt-0.5">3</span>
                <span>ç‚¹å‡»"è·å¾—50 SHT"æŒ‰é’®è¿›è¡Œæµ‹è¯•ç©ºæŠ•</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mt-0.5">4</span>
                <span>ä½¿ç”¨æ¯æ—¥ç­¾åˆ°åŠŸèƒ½è·å¾—100 SHT + è¿ç»­å¥–åŠ±</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mt-0.5">5</span>
                <span>åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“ï¼Œç­‰å¾…åŒºå—ç¡®è®¤</span>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}