'use client';

import { useState, useEffect } from 'react';
import { useAccount, useReadContract, useWriteContract, useWaitForTransactionReceipt } from 'wagmi';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  Coins, 
  Calendar,
  Gift,
  TrendingUp,
  Clock,
  Star,
  Zap,
  CheckCircle,
  Trophy,
  Target,
  BarChart3,
  Flame
} from 'lucide-react';
import { CONTRACTS, SHT_TOKEN_ABI, formatTokenAmount } from '@/config/web3';
import { UserStats } from '@/types/user';
import { formatTime, formatNumber } from '@/lib/utils';
import { cn } from '@/lib/utils';

export default function TokensPage() {
  const { address, isConnected } = useAccount();
  const [userStats, setUserStats] = useState<UserStats | null>(null);
  const [canClaim, setCanClaim] = useState(false);
  const [estimatedReward, setEstimatedReward] = useState(0);

  // è¯»å–ç”¨æˆ·ä½™é¢
  const { data: balance } = useReadContract({
    address: CONTRACTS.SHT_TOKEN,
    abi: SHT_TOKEN_ABI,
    functionName: 'balanceOf',
    args: address ? [address] : undefined,
    query: { enabled: !!address },
  });

  // è¯»å–ç”¨æˆ·ç»Ÿè®¡
  const { data: stats } = useReadContract({
    address: CONTRACTS.SHT_TOKEN,
    abi: SHT_TOKEN_ABI,
    functionName: 'getUserStats',
    args: address ? [address] : undefined,
    query: { enabled: !!address },
  });

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç­¾åˆ°
  const { data: canClaimToday } = useReadContract({
    address: CONTRACTS.SHT_TOKEN,
    abi: SHT_TOKEN_ABI,
    functionName: 'canClaimToday',
    args: address ? [address] : undefined,
    query: { enabled: !!address },
  });

  // è®¡ç®—é¢„æœŸå¥–åŠ±
  const { data: dailyReward } = useReadContract({
    address: CONTRACTS.SHT_TOKEN,
    abi: SHT_TOKEN_ABI,
    functionName: 'calculateDailyReward',
    args: address ? [address] : undefined,
    query: { enabled: !!address },
  });

  // ç­¾åˆ°
  const { writeContract, data: hash, isPending } = useWriteContract();
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ hash });

  useEffect(() => {
    if (stats) {
      setUserStats({
        lastClaimTime: Number(stats.lastClaimTime),
        consecutiveDays: Number(stats.consecutiveDays),
        totalClaimed: stats.totalClaimed,
        mintCount: Number(stats.mintCount),
        totalClaimedInEth: Number(formatTokenAmount(stats.totalClaimed)),
        canClaimToday: Boolean(canClaimToday),
      });
    }

    setCanClaim(Boolean(canClaimToday));
    setEstimatedReward(dailyReward ? Number(formatTokenAmount(dailyReward)) : 0);
  }, [stats, canClaimToday, dailyReward]);

  const handleClaim = () => {
    if (!address || !canClaim) return;
    
    writeContract({
      address: CONTRACTS.SHT_TOKEN,
      abi: SHT_TOKEN_ABI,
      functionName: 'claimDailyReward',
    });
  };

  // è®¡ç®—è¿ç»­ç­¾åˆ°è¿›åº¦
  const getStreakProgress = (days: number) => {
    const milestones = [7, 30, 100, 365];
    const currentMilestone = milestones.find(m => days < m) || 365;
    const progress = (days / currentMilestone) * 100;
    return { progress: Math.min(progress, 100), milestone: currentMilestone };
  };

  const streakInfo = userStats ? getStreakProgress(userStats.consecutiveDays) : { progress: 0, milestone: 7 };

  if (!isConnected) {
    return (
      <div className="container mx-auto px-4 py-8">
        <Card className="max-w-2xl mx-auto bg-white/5 border-white/10 backdrop-blur-sm">
          <CardContent className="p-12 text-center">
            <Coins className="h-16 w-16 mx-auto mb-4 text-yellow-400" />
            <h2 className="text-2xl font-bold mb-2 text-white">SHT ä»£å¸ä¸­å¿ƒ</h2>
            <p className="text-white/60 mb-6">
              è¿æ¥é’±åŒ…å¼€å§‹æ¯æ—¥ç­¾åˆ°ï¼Œè·å–SHTä»£å¸å¥–åŠ±
            </p>
            <div className="text-sm text-white/50">
              æ¯æ—¥ç­¾åˆ°å¯è·å¾—SHTä»£å¸ï¼Œè¿ç»­ç­¾åˆ°å¥–åŠ±æ›´ä¸°åš
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8 space-y-8">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="text-center space-y-4">
        <h1 className="text-3xl font-bold text-white flex items-center justify-center gap-2">
          <Coins className="h-8 w-8 text-yellow-400" />
          SHT ä»£å¸ä¸­å¿ƒ
        </h1>
        <p className="text-white/70">æ¯æ—¥ç­¾åˆ°è·å–ä»£å¸ï¼Œè¿ç»­ç­¾åˆ°å¥–åŠ±æ›´ä¸°åš</p>
      </div>

      {/* ç”¨æˆ·æ¦‚è§ˆ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
          <CardContent className="p-6 text-center">
            <div className="space-y-2">
              <Coins className="h-8 w-8 text-yellow-400 mx-auto" />
              <div className="text-3xl font-bold text-white">
                {balance ? formatTokenAmount(balance) : '0'}
              </div>
              <div className="text-sm text-white/60">SHT ä½™é¢</div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
          <CardContent className="p-6 text-center">
            <div className="space-y-2">
              <Flame className="h-8 w-8 text-orange-400 mx-auto" />
              <div className="text-3xl font-bold text-white">
                {userStats?.consecutiveDays || 0}
              </div>
              <div className="text-sm text-white/60">è¿ç»­ç­¾åˆ°</div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
          <CardContent className="p-6 text-center">
            <div className="space-y-2">
              <Gift className="h-8 w-8 text-green-400 mx-auto" />
              <div className="text-3xl font-bold text-white">
                {userStats?.totalClaimedInEth?.toFixed(0) || '0'}
              </div>
              <div className="text-sm text-white/60">æ€»è®¡é¢†å–</div>
            </div>
          </CardContent>
        </Card>

        <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
          <CardContent className="p-6 text-center">
            <div className="space-y-2">
              <Target className="h-8 w-8 text-purple-400 mx-auto" />
              <div className="text-3xl font-bold text-white">
                {userStats?.mintCount || 0}
              </div>
              <div className="text-sm text-white/60">é“¸é€ æ¬¡æ•°</div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* æ¯æ—¥ç­¾åˆ° */}
      <Card className="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-yellow-500/30">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-white">
            <Calendar className="h-5 w-5" />
            æ¯æ—¥ç­¾åˆ°
          </CardTitle>
          <CardDescription className="text-white/70">
            æ¯æ—¥ç­¾åˆ°è·å–SHTä»£å¸ï¼Œè¿ç»­ç­¾åˆ°è·å¾—é¢å¤–å¥–åŠ±
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="text-center space-y-4">
            {canClaim ? (
              <div className="space-y-4">
                <div className="space-y-2">
                  <div className="text-2xl font-bold text-white">
                    ä»Šæ—¥å¯è·å¾— {estimatedReward.toFixed(0)} SHT
                  </div>
                  <div className="text-white/70">
                    {userStats?.consecutiveDays ? `è¿ç»­ç­¾åˆ° ${userStats.consecutiveDays} å¤©` : 'å¼€å§‹è¿ç»­ç­¾åˆ°'}
                  </div>
                </div>
                
                <Button
                  onClick={handleClaim}
                  disabled={isPending || isConfirming}
                  loading={isPending || isConfirming}
                  size="lg"
                  variant="gradient"
                  className="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600"
                >
                  {isPending || isConfirming ? (
                    'ç­¾åˆ°ä¸­...'
                  ) : (
                    <>
                      <Gift className="mr-2 h-5 w-5" />
                      ç«‹å³ç­¾åˆ°
                    </>
                  )}
                </Button>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="space-y-2">
                  <CheckCircle className="h-12 w-12 text-green-400 mx-auto" />
                  <div className="text-xl font-bold text-white">
                    ä»Šæ—¥å·²ç­¾åˆ°
                  </div>
                  <div className="text-white/70">
                    æ˜æ—¥å†æ¥é¢†å–æ›´å¤šå¥–åŠ±
                  </div>
                </div>
                
                <div className="text-sm text-white/60">
                  {userStats?.lastClaimTime && (
                    <div>ä¸Šæ¬¡ç­¾åˆ°ï¼š{formatTime.datetime(userStats.lastClaimTime * 1000)}</div>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* ç­¾åˆ°è¿›åº¦ */}
          <div className="space-y-3">
            <div className="flex items-center justify-between text-sm">
              <span className="text-white/70">è¿ç»­ç­¾åˆ°è¿›åº¦</span>
              <span className="text-white">
                {userStats?.consecutiveDays || 0} / {streakInfo.milestone} å¤©
              </span>
            </div>
            <Progress value={streakInfo.progress} className="h-2" />
            <div className="text-xs text-white/60 text-center">
              è¾¾åˆ° {streakInfo.milestone} å¤©è¿ç»­ç­¾åˆ°è·å¾—ç‰¹æ®Šå¥–åŠ±
            </div>
          </div>
        </CardContent>
      </Card>

      {/* å¥–åŠ±è§„åˆ™ */}
      <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-white">
            <Star className="h-5 w-5" />
            å¥–åŠ±è§„åˆ™
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div className="space-y-2">
              <h4 className="font-medium text-white">åŸºç¡€å¥–åŠ±</h4>
              <div className="text-sm text-white/70">
                æ¯æ—¥ç­¾åˆ°ï¼š10 SHT
              </div>
            </div>
            
            <div className="space-y-2">
              <h4 className="font-medium text-white">è¿ç»­å¥–åŠ±</h4>
              <div className="text-sm text-white/70 space-y-1">
                <div>7å¤©ï¼š+5 SHT</div>
                <div>30å¤©ï¼š+10 SHT</div>
                <div>100å¤©ï¼š+20 SHT</div>
              </div>
            </div>
            
            <div className="space-y-2">
              <h4 className="font-medium text-white">åˆ›ä½œå¥–åŠ±</h4>
              <div className="text-sm text-white/70">
                é“¸é€ ç¥å…½ï¼š50 SHT
              </div>
            </div>
          </div>

          <div className="border-t border-white/10 pt-4">
            <h4 className="font-medium text-white mb-2">ç‰¹æ®Šæ´»åŠ¨</h4>
            <div className="text-sm text-white/70">
              â€¢ èŠ‚å‡æ—¥åŒå€å¥–åŠ±
              â€¢ é™æ—¶åˆ›ä½œæŒ‘æˆ˜
              â€¢ ç¤¾åŒºæ´»åŠ¨å¥–åŠ±
            </div>
          </div>
        </CardContent>
      </Card>

      {/* æˆå°±ç³»ç»Ÿ */}
      <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-white">
            <Trophy className="h-5 w-5" />
            æˆå°±å¾½ç« 
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {[
              { name: 'åˆæ¥ä¹åˆ°', desc: 'é¦–æ¬¡ç­¾åˆ°', icon: 'ğŸ¯', earned: userStats?.consecutiveDays ? userStats.consecutiveDays >= 1 : false },
              { name: 'åšæŒä¸æ‡ˆ', desc: 'è¿ç»­ç­¾åˆ°7å¤©', icon: 'ğŸ”¥', earned: userStats?.consecutiveDays ? userStats.consecutiveDays >= 7 : false },
              { name: 'æœˆåº¦è¾¾äºº', desc: 'è¿ç»­ç­¾åˆ°30å¤©', icon: 'ğŸŒŸ', earned: userStats?.consecutiveDays ? userStats.consecutiveDays >= 30 : false },
              { name: 'ç™¾æ—¥åšæŒ', desc: 'è¿ç»­ç­¾åˆ°100å¤©', icon: 'ğŸ’', earned: userStats?.consecutiveDays ? userStats.consecutiveDays >= 100 : false },
            ].map((achievement, index) => (
              <div
                key={index}
                className={cn(
                  "p-4 rounded-lg border text-center transition-all",
                  achievement.earned
                    ? "bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border-yellow-500/30"
                    : "bg-white/5 border-white/10"
                )}
              >
                <div className="text-3xl mb-2">{achievement.icon}</div>
                <div className={cn(
                  "font-medium mb-1",
                  achievement.earned ? "text-yellow-400" : "text-white/70"
                )}>
                  {achievement.name}
                </div>
                <div className="text-xs text-white/60">
                  {achievement.desc}
                </div>
                {achievement.earned && (
                  <Badge className="mt-2 bg-yellow-500/20 text-yellow-400 border-yellow-500/30">
                    å·²è·å¾—
                  </Badge>
                )}
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}